pipeline {
    agent any
    options {
        skipStagesAfterUnstable()
    }
    stages { 
        stage('Restore packages') {
			steps {
				bat '"C:\\Program Files\\dotnet\\dotnet" restore "CAHFS Emailer.sln"'
			}
		}
        stage('Clean Previous Build') {
			steps {
				bat '"C:\\Program Files\\dotnet\\dotnet" clean "CAHFS Emailer.sln"'
			}
		}
		stage('Build for test') {
			when {
				expression { params.Branch == 'development' }
			}
			steps {
				bat '"C:\\Program Files\\dotnet\\dotnet" publish "./CAHFS Emailer/CAHFS Emailer.csproj" -c "Release" /p:EnvironmentName=Test'
			}
		}
		stage('Build for prod') {
			when {
				expression { params.Branch == "main" }
			}
			steps {
				bat '"C:\\Program Files\\dotnet\\dotnet" publish "./CAHFS Emailer/CAHFS Emailer.csproj" -c "Release" /p:EnvironmentName=Production'
			}
		}
		/*
		stage('Tests') {
			steps {
				bat '"C:\\Program Files\\dotnet\\dotnet" test ./test/Viper.test.csproj -e Test --logger "junit" --configuration release --nologo'
            }
		}
		*/
		stage('Deploy to test') {
			when {
				expression { params.Branch == 'development' }
			}
			steps {
				bat 'type NUL > app_offline.htm'
				bat 'robocopy "." "C:\\inetpub\\wwwroot\\emailer-test" /IF app_offline.htm /S /E /DCOPY:DA /COPY:DAT /PURGE /MIR /R:10 /W:3) & IF %ERRORLEVEL% LSS 8 EXIT /B 0'
				bat 'robocopy ".\\CAHFS Emailer\\bin\\Release\\net10.0\\publish" "C:\\inetpub\\wwwroot\\emailer-test" /S /E /DCOPY:DA /COPY:DAT /PURGE /MIR /R:10 /W:3) & IF %ERRORLEVEL% LSS 8 EXIT /B 0'
			}
		}
		stage('Deploy to prod') {
			when {
				expression { params.Branch == "main" }
			}
			steps {
				bat 'type NUL > app_offline.htm'
				bat 'robocopy "." "C:\\inetpub\\wwwroot\\emailer" /IF app_offline.htm /S /E /DCOPY:DA /COPY:DAT /PURGE /MIR /R:10 /W:3) & IF %ERRORLEVEL% LSS 8 EXIT /B 0'
				bat 'robocopy ".\\CAHFS Emailer\\bin\\Release\\net10.0\\publish" "C:\\inetpub\\wwwroot\\emailer" /S /E /DCOPY:DA /COPY:DAT /PURGE /MIR /R:10 /W:3) & IF %ERRORLEVEL% LSS 8 EXIT /B 0'
			}
		}
    }
	post {
		success {
				script {
					def targetUrl = ""
					if (params.Branch == 'main') {
						targetUrl = "http://cahfs-caei.cahfs.ucdavis.edu/emailer"
					} else {
						targetUrl = "http://cahfs-caei.cahfs.ucdavis.edu/emailer-test"
					}
					//def response = httpRequest httpMode: 'GET', url: 'http://cahfs-caei.cahfs.ucdavis.edu/emailer-test', validResponseCodes: '200'
					bat "curl -G \"${targetUrl}\""
				}
			}
			always {
				//Archive the artifacts - in this case, all files - so that the restore job can re-deploy them.
				archiveArtifacts artifacts: 'CAHFS Emailer/bin/Release/net10.0/publish/**/*', fingerprint: true, onlyIfSuccessful: true
			}
		}
}